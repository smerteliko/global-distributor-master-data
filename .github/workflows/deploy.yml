name: Deploy MasterData Service

on:
  push:
    branches: ["master"]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build with Maven
        run: .\mvnw clean package -DskipTests

      - name: Deploy via PM2 Ecosystem
        shell: powershell
        env:
          PM2_HOME: "C:\\Users\\Administrator\\.pm2"
        run: |
          # --- 1. –ù–ê–°–¢–†–û–ô–ö–ò ---
          $AppName = "masterdata-backend"
          $TargetDir = "C:\GlobalDist\apps\masterdata"
          $TargetJar = "$TargetDir\app.jar"
          $EcosystemFile = "$TargetDir\ecosystem.config.js"
          
          # –ü—É—Ç–∏ –¥–ª—è JS (–¥–≤–æ–π–Ω—ã–µ —Å–ª–µ—à–∏)
          $JavaPathJS = "C:\\Program Files\\OpenJDK\\jdk-25\\bin\\java.exe"
          $TargetJarJS = "C:\\GlobalDist\\apps\\masterdata\\app.jar"
          
          # üî• –°–°–´–õ–ö–ê –ù–ê –í–ê–® –ö–û–ù–§–ò–ì –§–ê–ô–õ –ù–ê –°–ï–†–í–ï–†–ï üî•
          # –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª C:\GlobalDist\config\masterdata.yaml —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!
          $ConfigPathJS = "file:C:\\GlobalDist\\config\\masterdata.yaml"
          
          $LogFileJS = "C:\\GlobalDist\\logs\\masterdata.log"
          $PM2 = "C:\Users\Administrator\AppData\Roaming\npm\pm2.cmd"

          # –ò—â–µ–º JAR
          $SourceJar = Get-ChildItem -Path ".\target\*.jar" | Where-Object { $_.Name -notlike "original-*" } | Select-Object -First 1
          if (!$SourceJar) { Write-Error "Build failed: JAR not found"; exit 1 }

          # --- 2. –ü–û–î–ì–û–¢–û–í–ö–ê ---
          Write-Host "Stopping old process..."
          if (Test-Path $PM2) { & $PM2 delete $AppName } else { pm2 delete $AppName }
          $LASTEXITCODE = 0 
          Start-Sleep -Seconds 2

          # --- 3. –ö–û–ü–ò–†–û–í–ê–ù–ò–ï ---
          if (!(Test-Path -Path $TargetDir)) { New-Item -ItemType Directory -Force -Path $TargetDir }
          if (!(Test-Path -Path "C:\GlobalDist\logs")) { New-Item -ItemType Directory -Force -Path "C:\GlobalDist\logs" }

          Write-Host "Copying JAR..."
          Copy-Item -Path $SourceJar.FullName -Destination $TargetJar -Force

          # --- 4. –ì–ï–ù–ï–†–ê–¶–ò–Ø –ö–û–ù–§–ò–ì–ê ---
          # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥, –∏—Å–ø–æ–ª—å–∑—É—è –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ Spring
          
          $EcosystemContent = @"
          module.exports = {
            apps : [{
              name: '$AppName',
              script: '$JavaPathJS',
              args: [
                '-jar',
                '$TargetJarJS'
              ],
              env: {
                'SPRING_CONFIG_LOCATION': '$ConfigPathJS'
              },
              exec_mode: 'fork',
              instances: 1,
              autorestart: true,
              watch: false,
              time: true,
              out_file: '$LogFileJS',
              error_file: '$LogFileJS',
              merge_logs: true
            }]
          };
          "@
          
          Set-Content -Path $EcosystemFile -Value $EcosystemContent
          Write-Host "Config generated at $EcosystemFile"

          # --- 5. –ó–ê–ü–£–°–ö ---
          Write-Host "Starting MasterData..."
          if (Test-Path $PM2) { 
             & $PM2 start $EcosystemFile
             & $PM2 save
          } else { 
             pm2 start $EcosystemFile
             pm2 save
          }
          
          Write-Host "Deployment done!"